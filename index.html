<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DARA Research Passport - 0G Blockchain Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        .mono {
            font-family: 'JetBrains Mono', monospace;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .gradient-text {
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .nft-card {
            background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid rgba(96, 165, 250, 0.2);
            transition: all 0.3s ease;
        }
        .nft-card:hover {
            border-color: rgba(96, 165, 250, 0.5);
            box-shadow: 0 10px 40px -10px rgba(96, 165, 250, 0.3);
        }
        .network-badge {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }
        .trust-wallet-btn {
            background: linear-gradient(135deg, #3375bb 0%, #0056b3 100%);
        }
        .attribute-tag {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .verified-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a;
        }
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }
    </style>
</head>
<body class="text-slate-200">

    <!-- Header -->
    <header class="glass-panel sticky top-0 z-50 border-b border-slate-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold text-lg">
                        0G
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">DARA Research Passport</h1>
                        <p class="text-xs text-slate-400">0G Blockchain NFT Viewer</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <select id="networkSelect" class="bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                        <option value="mainnet">Aristotle Mainnet</option>
                        <option value="testnet">Galileo Testnet</option>
                    </select>

                    <button id="connectWallet" class="trust-wallet-btn text-white px-6 py-2 rounded-lg font-medium flex items-center space-x-2 hover:opacity-90 transition-opacity">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                        </svg>
                        <span>Connect Trust Wallet</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Wallet Info Panel -->
        <div id="walletInfo" class="hidden glass-panel rounded-2xl p-6 mb-8 border border-slate-700">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <p class="text-sm text-slate-400 mb-1">Connected Wallet</p>
                    <p id="walletAddress" class="mono text-lg font-semibold text-blue-400"></p>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Network</p>
                        <p id="networkName" class="font-semibold text-purple-400">Aristotle Mainnet</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-400">Balance</p>
                        <p id="walletBalance" class="font-semibold text-green-400">-- AOGI</p>
                    </div>
                    <button onclick="disconnectWallet()" class="text-red-400 hover:text-red-300 text-sm underline">
                        Disconnect
                    </button>
                </div>
            </div>
        </div>

        <!-- Not Connected State -->
        <div id="notConnected" class="text-center py-20">
            <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-slate-800 flex items-center justify-center">
                <svg class="w-12 h-12 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Connect Your Wallet</h2>
            <p class="text-slate-400 mb-8 max-w-md mx-auto">Connect your Trust Wallet to view your DARA Research Passport NFTs purchased from the marketplace.</p>
            <button onclick="connectWallet()" class="trust-wallet-btn text-white px-8 py-3 rounded-xl font-semibold text-lg hover:opacity-90 transition-opacity">
                Connect Trust Wallet
            </button>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <p class="mt-4 text-slate-400">Querying blockchain for your NFTs...</p>
        </div>

        <!-- NFT Grid -->
        <div id="nftContainer" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white">Your Research Passports</h2>
                <span id="nftCount" class="px-3 py-1 rounded-full bg-slate-800 text-sm text-slate-300 border border-slate-700">0 NFTs</span>
            </div>

            <div id="nftGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- NFTs will be injected here -->
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden mt-4 p-4 rounded-lg bg-red-900/30 border border-red-700 text-red-200">
            <p id="errorText"></p>
        </div>
    </main>

    <!-- NFT Detail Modal -->
    <div id="nftModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-slate-900 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeModal()"></div>
            
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            
            <div class="inline-block align-bottom glass-panel rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full border border-slate-700">
                <div id="modalContent" class="p-6">
                    <!-- Content injected via JS -->
                </div>
                <div class="bg-slate-800/50 px-6 py-4 flex justify-end space-x-3">
                    <button onclick="closeModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            mainnet: {
                chainId: '0x4115',
                chainIdDecimal: 16661,
                name: '0G-AI (Aristotle)',
                rpcUrl: 'https://evmrpc.0g.ai',
                explorer: 'https://chainscan.0g.ai',
                contracts: {
                    drp: '0x3156f6e761d7c9da0a88a6165864995f2b58854f',
                    marketplace: '0x57e463BF845cf328715446b9246fFa536B671A10',
                    oracle: '0xa4e554b54cF94BfBca0682c34877ee7C96aC9261'
                }
            },
            testnet: {
                chainId: '0x40da',
                chainIdDecimal: 16602,
                name: '0G-Galileo',
                rpcUrl: 'https://evmrpc-testnet.0g.ai',
                explorer: 'https://chainscan-testnet.0g.ai',
                contracts: {
                    drp: '0x3156f6e761d7c9da0a88a6165864995f2b58854f',
                    marketplace: '0x57e463BF845cf328715446b9246fFa536B671A10',
                    oracle: '0xa4e554b54cF94BfBca0682c34877ee7C96aC9261'
                }
            }
        };

        // Minimal ABI for DRP Contract (only functions we need)
        const DRP_ABI = [
            "function ownerOf(uint256 tokenId) view returns (address)",
            "function tokenURI(uint256 tokenId) view returns (string)"
        ];

        // ABI for DARA Marketplace
        const MARKETPLACE_ABI = [
            "function getListingDetails(uint256 listingId) view returns (tuple(uint256 listingId, address seller, address nftContract, uint256 tokenId, uint256 price, uint256 quantity, uint256 totalSupply, bool active, uint256 createdAt), tuple(string title, string category, string researchType, uint256 quality, uint256 citations, string imageUrl, bytes32 verificationHash))",
            "function listings(uint256) view returns (uint256 listingId, address seller, address nftContract, uint256 tokenId, uint256 price, uint256 quantity, uint256 totalSupply, bool active, uint256 createdAt)"
        ];

        // State
        let provider;
        let signer;
        let currentNetwork = 'mainnet';
        let userAddress = null;
        let userNFTs = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('networkSelect').addEventListener('change', (e) => {
                currentNetwork = e.target.value;
                if (userAddress) {
                    loadNFTs();
                }
            });

            document.getElementById('connectWallet').addEventListener('click', connectWallet);
        });

        // Connect Wallet Function
        async function connectWallet() {
            try {
                // Mobile Trust Wallet detection
                if (!window.ethereum) {
                    const currentUrl = window.location.href;
                    const trustWalletDeepLink = `https://link.trustwallet.com/open_url?coin_id=60&url=${encodeURIComponent(currentUrl)}`;
                    window.location.href = trustWalletDeepLink;
                    return;
                }

                // Request account access
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });

                if (accounts.length === 0) {
                    throw new Error('No accounts found');
                }

                userAddress = accounts[0].toLowerCase();
                
                // Setup provider
                provider = new ethers.providers.Web3Provider(window.ethereum, "any");
                signer = provider.getSigner();

                // Check and switch network if needed
                await checkNetwork();

                // Update UI
                updateWalletUI();
                
                // Load NFTs
                await loadNFTs();

                // Listen for changes
                window.ethereum.on('accountsChanged', (newAccounts) => {
                    if (newAccounts.length === 0) {
                        disconnectWallet();
                    } else {
                        userAddress = newAccounts[0].toLowerCase();
                        updateWalletUI();
                        loadNFTs();
                    }
                });

                window.ethereum.on('chainChanged', () => {
                    window.location.reload();
                });

            } catch (error) {
                showError(error.message);
                console.error('Connection error:', error);
            }
        }

        // Check and switch network
        async function checkNetwork() {
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            const targetChainId = CONFIG[currentNetwork].chainId;
            
            if (chainId !== targetChainId) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: targetChainId }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        const network = CONFIG[currentNetwork];
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: targetChainId,
                                chainName: network.name,
                                nativeCurrency: {
                                    name: 'AOGI',
                                    symbol: 'AOGI',
                                    decimals: 18
                                },
                                rpcUrls: [network.rpcUrl],
                                blockExplorerUrls: [network.explorer]
                            }],
                        });
                    } else {
                        throw switchError;
                    }
                }
            }
        }

        // Update Wallet UI
        async function updateWalletUI() {
            document.getElementById('notConnected').classList.add('hidden');
            document.getElementById('walletInfo').classList.remove('hidden');
            
            document.getElementById('walletAddress').textContent = 
                `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
            document.getElementById('networkName').textContent = CONFIG[currentNetwork].name;
            
            // Get balance
            const balance = await provider.getBalance(userAddress);
            const balanceFormatted = ethers.utils.formatEther(balance);
            document.getElementById('walletBalance').textContent = 
                `${parseFloat(balanceFormatted).toFixed(4)} AOGI`;
        }

        // Load NFTs - THE CORE FUNCTION
        async function loadNFTs() {
            try {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('nftContainer').classList.add('hidden');
                document.getElementById('nftGrid').innerHTML = '';
                
                const drpContract = new ethers.Contract(
                    CONFIG[currentNetwork].contracts.drp,
                    DRP_ABI,
                    provider
                );

                const marketplaceContract = new ethers.Contract(
                    CONFIG[currentNetwork].contracts.marketplace,
                    MARKETPLACE_ABI,
                    provider
                );

                userNFTs = [];

                // Check Token IDs 1-4 directly from DRP contract
                for (let tokenId = 1; tokenId <= 4; tokenId++) {
                    try {
                        const owner = await drpContract.ownerOf(tokenId);
                        if (owner.toLowerCase() === userAddress) {
                            // Get metadata from marketplace (richer data)
                            let marketData = null;
                            try {
                                marketData = await marketplaceContract.getListingDetails(tokenId);
                            } catch (e) {
                                console.log(`No marketplace data for token ${tokenId}`);
                            }

                            // Get on-chain URI if available
                            let tokenURI = '';
                            try {
                                tokenURI = await drpContract.tokenURI(tokenId);
                            } catch (e) {
                                console.log(`No tokenURI for token ${tokenId}`);
                            }

                            userNFTs.push({
                                tokenId: tokenId.toString(),
                                source: 'drp',
                                owner: owner,
                                tokenURI: tokenURI,
                                marketplaceData: marketData,
                                transactionHash: getTransactionHash(tokenId)
                            });
                        }
                    } catch (e) {
                        console.log(`Token ${tokenId} not owned or error:`, e.message);
                    }
                }

                // Check Token ID 5 via Marketplace Listing 9
                try {
                    const listing9Data = await marketplaceContract.getListingDetails(9);
                    // Check if this listing is for tokenId 5 and if user owns it
                    if (listing9Data && listing9Data[0] && listing9Data[0].tokenId.toString() === '5') {
                        // Try to get owner from DRP contract
                        try {
                            const ownerOf5 = await drpContract.ownerOf(5);
                            if (ownerOf5.toLowerCase() === userAddress) {
                                userNFTs.push({
                                    tokenId: '5',
                                    source: 'marketplace',
                                    listingId: '9',
                                    owner: ownerOf5,
                                    marketplaceData: listing9Data,
                                    transactionHash: getTransactionHash(5)
                                });
                            }
                        } catch (e) {
                            // If ownerOf fails, check if user is the buyer from transaction
                            // For now, we'll show it if we can't verify but it was purchased
                            console.log('Token 5 ownership check via DRP failed, checking marketplace...');
                        }
                    }
                } catch (e) {
                    console.log('Listing 9 (Token 5) query failed:', e.message);
                }

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('nftContainer').classList.remove('hidden');
                
                renderNFTs();

            } catch (error) {
                document.getElementById('loadingState').classList.add('hidden');
                showError('Failed to load NFTs: ' + error.message);
                console.error('Load NFTs error:', error);
            }
        }

        // Get transaction hash for display
        function getTransactionHash(tokenId) {
            const hashes = {
                1: '0x97e08510a036e0607a9cc2dd811cb33b3247d55ba1733748f8aef0047d692064',
                2: '0xf3b10318167418c2995c9e96d903156356a7f32f9a50bee3601faf56e6ec6a8b',
                3: '0x76b954075bec3e29ca939d28b816008c28e587375c8a74bcdb720a5f1f6e16c2',
                4: '0x536664f67d153431c4e7fb09b5d288118aea6c4f0b2dfed1b87ae5968e018d36',
                5: '0xae7ab735ce14c3e11ce2b912b92da4bf6f00fed09050b82adb42ac0f854eaf97'
            };
            return hashes[tokenId] || '';
        }

        // Render NFTs
        function renderNFTs() {
            const grid = document.getElementById('nftGrid');
            grid.innerHTML = '';
            
            document.getElementById('nftCount').textContent = `${userNFTs.length} NFTs`;
            
            if (userNFTs.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <p class="text-slate-400 mb-2">No Research Passports found for this wallet.</p>
                        <p class="text-sm text-slate-500">Make sure you're on the correct network (Aristotle Mainnet)</p>
                    </div>
                `;
                return;
            }

            userNFTs.forEach((nft) => {
                const card = createNFTCard(nft);
                grid.appendChild(card);
            });
        }

        // Create NFT Card
        function createNFTCard(nft) {
            const div = document.createElement('div');
            div.className = 'nft-card rounded-xl overflow-hidden cursor-pointer';
            div.onclick = () => showNFTDetails(nft);
            
            // Extract metadata from marketplace data
            let title = `Research Passport #${nft.tokenId}`;
            let category = 'Research';
            let quality = 0;
            let imageUrl = 'https://images.unsplash.com/photo-1639322537228-f710d846310a?w=800&q=80';
            let isVerified = false;
            
            if (nft.marketplaceData && nft.marketplaceData[1]) {
                const metadata = nft.marketplaceData[1];
                title = metadata.title || title;
                category = metadata.category || category;
                quality = metadata.quality ? metadata.quality.toString() : 0;
                imageUrl = metadata.imageUrl || imageUrl;
            }

            // Parse tokenURI if available
            if (nft.tokenURI && nft.tokenURI.startsWith('data:application/json;base64,')) {
                try {
                    const base64 = nft.tokenURI.split(',')[1];
                    const parsed = JSON.parse(atob(base64));
                    if (parsed.name) title = parsed.name;
                    if (parsed.attributes) {
                        const verifiedAttr = parsed.attributes.find(a => a.trait_type === 'Verified');
                        if (verifiedAttr && verifiedAttr.value === 'true') isVerified = true;
                    }
                } catch (e) {}
            }

            div.innerHTML = `
                <div class="aspect-video bg-slate-800 relative overflow-hidden">
                    <img src="${imageUrl}" alt="${title}" class="w-full h-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1639322537228-f710d846310a?w=800&q=80'">
                    <div class="absolute top-2 right-2 network-badge text-white text-xs px-2 py-1 rounded-full font-semibold">
                        #${nft.tokenId}
                    </div>
                    ${isVerified ? `
                    <div class="absolute top-2 left-2 verified-badge text-white text-xs px-2 py-1 rounded-full font-semibold flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        Verified
                    </div>
                    ` : ''}
                </div>
                <div class="p-5">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold text-white">${title}</h3>
                        ${quality > 0 ? `<span class="text-xs bg-blue-900/50 text-blue-300 px-2 py-1 rounded border border-blue-700">Quality: ${quality}</span>` : ''}
                    </div>
                    <p class="text-sm text-slate-400 mb-3">${category}</p>
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-slate-500 mono">ERC-7857</span>
                        <span class="text-blue-400 font-medium">View Details â†’</span>
                    </div>
                </div>
            `;
            
            return div;
        }

        // Show NFT Details Modal
        function showNFTDetails(nft) {
            const modal = document.getElementById('nftModal');
            const content = document.getElementById('modalContent');
            
            let title = `Research Passport #${nft.tokenId}`;
            let description = 'DARA Research Passport NFT';
            let category = 'Research';
            let researchType = 'Unknown';
            let quality = 0;
            let citations = 0;
            let imageUrl = 'https://images.unsplash.com/photo-1639322537228-f710d846310a?w=800&q=80';
            let verificationHash = '';
            let price = '0';
            let seller = '';
            let attributes = [];
            let isActive = false;

            // Extract from marketplace data
            if (nft.marketplaceData) {
                const listing = nft.marketplaceData[0];
                const metadata = nft.marketplaceData[1];
                
                if (metadata) {
                    title = metadata.title || title;
                    category = metadata.category || category;
                    researchType = metadata.researchType || researchType;
                    quality = metadata.quality ? metadata.quality.toString() : 0;
                    citations = metadata.citations ? metadata.citations.toString() : 0;
                    imageUrl = metadata.imageUrl || imageUrl;
                    verificationHash = metadata.verificationHash || '';
                }
                
                if (listing) {
                    price = ethers.utils.formatEther(listing.price || '0');
                    seller = listing.seller;
                    isActive = listing.active;
                }
            }

            // Parse on-chain tokenURI
            if (nft.tokenURI) {
                try {
                    if (nft.tokenURI.startsWith('data:application/json;base64,')) {
                        const base64 = nft.tokenURI.split(',')[1];
                        const parsed = JSON.parse(atob(base64));
                        description = parsed.description || description;
                        if (parsed.attributes) attributes = parsed.attributes;
                    } else if (nft.tokenURI.startsWith('{')) {
                        const parsed = JSON.parse(nft.tokenURI);
                        description = parsed.description || description;
                        if (parsed.attributes) attributes = parsed.attributes;
                    }
                } catch (e) {
                    console.log('Failed to parse tokenURI');
                }
            }

            content.innerHTML = `
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="md:w-1/2">
                        <div class="relative rounded-lg overflow-hidden border border-slate-700">
                            <img src="${imageUrl}" alt="${title}" class="w-full object-cover" onerror="this.src='https://images.unsplash.com/photo-1639322537228-f710d846310a?w=800&q=80'">
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-slate-900 to-transparent p-4">
                                <p class="text-xs text-slate-400 mono">Token ID: ${nft.tokenId}</p>
                            </div>
                        </div>
                        
                        ${nft.transactionHash ? `
                        <div class="mt-4 p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                            <p class="text-xs text-slate-500 mb-1">Purchase Transaction</p>
                            <a href="${CONFIG[currentNetwork].explorer}/tx/${nft.transactionHash}" target="_blank" class="mono text-xs text-blue-400 hover:underline break-all">
                                ${nft.transactionHash}
                            </a>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="md:w-1/2 space-y-4">
                        <div>
                            <h3 class="text-2xl font-bold text-white mb-1">${title}</h3>
                            <p class="text-slate-400 text-sm">${description}</p>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                <p class="text-xs text-slate-500 mb-1">Category</p>
                                <p class="text-sm font-semibold text-blue-400">${category}</p>
                            </div>
                            <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                <p class="text-xs text-slate-500 mb-1">Research Type</p>
                                <p class="text-sm font-semibold text-purple-400">${researchType}</p>
                            </div>
                            <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                <p class="text-xs text-slate-500 mb-1">Quality Score</p>
                                <p class="text-sm font-semibold text-green-400">${quality}/100</p>
                            </div>
                            <div class="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                <p class="text-xs text-slate-500 mb-1">Citations</p>
                                <p class="text-sm font-semibold text-yellow-400">${citations}</p>
                            </div>
                        </div>

                        ${attributes.length > 0 ? `
                            <div>
                                <h4 class="text-sm font-semibold text-white mb-2">On-Chain Attributes</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    ${attributes.map(attr => `
                                        <div class="attribute-tag rounded-lg p-2">
                                            <p class="text-xs text-slate-500">${attr.trait_type}</p>
                                            <p class="text-sm text-blue-300 font-medium truncate" title="${attr.value}">${attr.value}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="bg-slate-800/30 rounded-lg p-4 border border-slate-700">
                            <h4 class="text-sm font-semibold text-white mb-2">Marketplace Data</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Purchase Price:</span>
                                    <span class="text-green-400 font-semibold">${price} AOGI</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Status:</span>
                                    <span class="${isActive ? 'text-green-400' : 'text-red-400'}">${isActive ? 'Active' : 'Inactive'}</span>
                                </div>
                                ${seller ? `
                                <div class="flex justify-between">
                                    <span class="text-slate-400">Seller:</span>
                                    <a href="${CONFIG[currentNetwork].explorer}/address/${seller}" target="_blank" class="text-blue-400 hover:underline mono text-xs">
                                        ${seller.slice(0, 6)}...${seller.slice(-4)}
                                    </a>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        ${verificationHash ? `
                        <div class="bg-slate-800/30 rounded-lg p-3 border border-slate-700">
                            <p class="text-xs text-slate-500 mb-1">Verification Hash</p>
                            <p class="mono text-xs text-slate-400 break-all">${verificationHash}</p>
                        </div>
                        ` : ''}

                        <div class="pt-4 border-t border-slate-700 space-y-2">
                            <a href="${CONFIG[currentNetwork].explorer}/token/${CONFIG[currentNetwork].contracts.drp}?a=${nft.tokenId}" 
                               target="_blank" 
                               class="block w-full text-center bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors">
                                View on 0G Explorer
                            </a>
                            ${nft.source === 'marketplace' && nft.listingId ? `
                            <a href="${CONFIG[currentNetwork].explorer}/address/${CONFIG[currentNetwork].contracts.marketplace}" 
                               target="_blank" 
                               class="block w-full text-center bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg transition-colors text-sm">
                               View Marketplace Contract
                            </a>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        // Close Modal
        function closeModal() {
            document.getElementById('nftModal').classList.add('hidden');
        }

        // Show Error
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // Disconnect
        function disconnectWallet() {
            userAddress = null;
            provider = null;
            signer = null;
            userNFTs = [];
            document.getElementById('walletInfo').classList.add('hidden');
            document.getElementById('nftContainer').classList.add('hidden');
            document.getElementById('notConnected').classList.remove('hidden');
            document.getElementById('loadingState').classList.add('hidden');
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>

</html>
